<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Payment System Test</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Services API</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testServices()">Load Services</button>
                        <div id="services-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Payments API</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testPayments()">Load Payments</button>
                        <div id="payments-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Instrumentalists API</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testInstrumentalists()">Load Instrumentalists</button>
                        <div id="instrumentalists-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Payment Form</h5>
                    </div>
                    <div class="card-body">
                        <form id="test-payment-form">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Instrumentalist</label>
                                        <select class="form-select" id="test-instrumentalist" required>
                                            <option value="">Select instrumentalist...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Service</label>
                                        <select class="form-select" id="test-service" required>
                                            <option value="">Select service...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Amount</label>
                                        <input type="number" class="form-control" id="test-amount" step="0.01" required>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="createTestPayment()">Create Test Payment</button>
                        </form>
                        <div id="payment-form-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info me-2" onclick="createTestData()">Create Test Data</button>
                        <button class="btn btn-warning me-2" onclick="loadAllData()">Load All Data</button>
                        <a href="index.php" class="btn btn-primary">Go to Main App</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function testServices() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading...';
            
            try {
                const response = await fetch('api/services.php');
                const text = await response.text();
                console.log('Services raw response:', text);
                
                const data = JSON.parse(text);
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success!</strong> Found ${data.length} services
                    </div>
                    <small class="text-muted">${JSON.stringify(data, null, 2)}</small>
                `;
                
                // Populate service dropdown
                const select = document.getElementById('test-service');
                select.innerHTML = '<option value="">Select service...</option>';
                data.forEach(service => {
                    const date = new Date(service.service_date).toLocaleDateString();
                    select.innerHTML += `<option value="${service.id}">${service.service_type} - ${date}</option>`;
                });
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function testPayments() {
            const resultDiv = document.getElementById('payments-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading...';
            
            try {
                const response = await fetch('api/payment_processing.php?action=pending_payments');
                const text = await response.text();
                console.log('Payments raw response:', text);
                
                const data = JSON.parse(text);
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success!</strong> Found ${data.length} payments
                    </div>
                    <small class="text-muted">${JSON.stringify(data, null, 2)}</small>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function testInstrumentalists() {
            const resultDiv = document.getElementById('instrumentalists-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading...';
            
            try {
                const response = await fetch('api/instrumentalists.php');
                const text = await response.text();
                console.log('Instrumentalists raw response:', text);
                
                const data = JSON.parse(text);
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success!</strong> Found ${data.length} instrumentalists
                    </div>
                    <small class="text-muted">${JSON.stringify(data, null, 2)}</small>
                `;
                
                // Populate instrumentalist dropdown
                const select = document.getElementById('test-instrumentalist');
                select.innerHTML = '<option value="">Select instrumentalist...</option>';
                data.forEach(inst => {
                    select.innerHTML += `<option value="${inst.id}">${inst.full_name} - ${inst.instrument}</option>`;
                });
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function createTestPayment() {
            const resultDiv = document.getElementById('payment-form-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Creating...';
            
            const data = {
                instrumentalist_id: document.getElementById('test-instrumentalist').value,
                service_id: document.getElementById('test-service').value,
                amount: document.getElementById('test-amount').value,
                payment_type: 'Per Service',
                notes: 'Test payment'
            };
            
            try {
                const response = await fetch('api/payment_processing.php?action=create_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const text = await response.text();
                console.log('Create payment response:', text);
                
                const result = JSON.parse(text);
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong> ${result.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function createTestData() {
            window.open('create_test_data.php', '_blank');
        }
        
        async function loadAllData() {
            await testServices();
            await testPayments();
            await testInstrumentalists();
        }
        
        // Load data on page load
        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
